# 蹲麻子 - 代码审查与改进建议

本文档基于对当前代码库的审查，从文件组织、代码结构、功能实现、硬编码与常见问题等维度给出结论与改进建议。建议作为迭代参考，按优先级逐步优化。

---

## 一、文件组织

### 现状

```
src/
├── App.jsx, main.jsx, index.css
├── config/supabase.js
├── constants/cards.js, gameConfig.js
├── stores/gameStore.js          # 单文件约 1900 行
├── utils/                        # 5 个工具/规则文件
└── components/                   # 约 14 个组件，扁平排列
    ├── Lobby.jsx, GameRoom.jsx, ActionLog.jsx, ...
    └── 每个组件对应同名 .css
```

### 优点

- 目录层级清晰：config、constants、stores、utils、components 分工明确。
- 常量与配置集中在 `constants/`，规则逻辑在 `utils/`，便于查找和修改。

### 可改进点

| 问题 | 建议 |
|------|------|
| **组件扁平** | 可按领域划分子目录，如 `components/lobby/`、`components/game/`、`components/shared/`，便于随功能增长扩展。 |
| **单 Store 过大** | `gameStore.js` 承担创建/加入/订阅/摸牌/出牌/换牌/弃牌/扣牌/响应/结算/下一局等全部逻辑，单文件约 1900 行，阅读与维护成本高。可考虑按领域拆分为多个 slice（如 `gameSlice`、`playerSlice`、`syncSlice`）或按功能模块拆文件再组合。 |
| **GameRoom 单文件过大** | `GameRoom.jsx` 约 1180 行，包含等待/对局/结算多种 UI、大量 useState（动画与 UI 状态）、以及所有操作回调。可考虑拆成子组件（如 `WaitingRoom`、`PlayingArea`、`HandArea`、`ActionButtons`）或自定义 Hook（如 `useFlyingCards`）以降低单文件复杂度。 |

---

## 二、代码结构与重复

### 1. 重复的「默认值」与取值模式

多处使用相同 fallback，未统一从配置读取：

- **目标分**：`game?.game_state?.target_score || 40` 在 GameRoom、gameStore、handEvaluation 等多处出现，建议统一为从 `game` 取，fallback 使用 `GAME_CONFIG.DEFAULT_TARGET_SCORE`。
- **手牌数/公共区容量**：`game?.hand_size ?? GAME_CONFIG.PUBLIC_ZONE_MAX` 或 `GAME_CONFIG.CARDS_PER_PLAYER` 在 store 与组件中重复出现，可抽成 store 的 selector 或工具函数，例如 `getHandSize(game)`、`getPublicZoneMax(game)`。
- **公共区**：`const publicZone = game?.game_state?.public_zone || []` 在 GameRoom 内多次出现，可提取为组件内变量或从 store 派生一次，避免重复书写。

**建议**：在 `gameConfig.js` 或 store 中提供少量 helpers，例如：

```js
// 示例：constants/gameConfig.js 或 utils/gameStateHelpers.js
export const getTargetScore = (game) => game?.game_state?.target_score ?? GAME_CONFIG.DEFAULT_TARGET_SCORE
export const getPublicZone = (game) => game?.game_state?.public_zone ?? []
export const getHandSize = (game) => game?.hand_size ?? GAME_CONFIG.CARDS_PER_PLAYER
```

组件与 store 统一通过此类函数取值，便于以后改配置或规则。

### 2. Store 内错误处理模式重复

gameStore 中多数 async action 采用同一模式：

- `set({ loading: true, error: null })`
- try 内写 DB，成功后 `set({ loading: false })` 或少量字段
- catch 内 `set({ error: error.message, loading: false })` 且常伴随 `await get().refreshGameState()`

该模式在十多个方法中重复。可考虑抽成高阶 helper，例如：

```js
const withLoading = async (fn) => {
  set({ loading: true, error: null })
  try {
    await fn()
  } catch (e) {
    set({ error: e.message, loading: false })
    await get().refreshGameState()
    throw e
  }
}
```

或在每个 action 内保持现状但将「错误处理 + refresh」封装成 `handleActionError(error)`，减少重复与遗漏。

### 3. Lobby 默认值与配置不一致

Lobby 中创建房间的默认值写死为数字：

- `useState(4)`、`useState(40)`、`useState(1)`、`useState(5)`

而 `gameConfig.js` 中已有 `DEFAULT_TOTAL_ROUNDS`、`DEFAULT_TARGET_SCORE`、`ROUND_OPTIONS`、`HAND_SIZE_OPTIONS` 等。建议 Lobby 的初始 state 从 GAME_CONFIG 或 OPTIONS 中取（例如取 recommended 项或默认项），避免与配置脱节，例如：

```js
const [totalRounds, setTotalRounds] = useState(GAME_CONFIG.DEFAULT_TOTAL_ROUNDS)
const [targetScore, setTargetScore] = useState(GAME_CONFIG.DEFAULT_TARGET_SCORE)
const [handSize, setHandSize] = useState(GAME_CONFIG.CARDS_PER_PLAYER)
```

---

## 三、硬编码与魔法数字

### 1. 时间/间隔（ms）

| 位置 | 当前值 | 含义 | 建议 |
|------|--------|------|------|
| ActionLog.jsx | 2500 | 轮询间隔 | 抽为常量如 `ACTION_LOG_POLL_INTERVAL_MS`，可放在 constants 或组件顶部 |
| ActionLog.jsx | 320 | 新条目高亮清除延迟 | 同上，如 `NEW_ENTRY_HIGHLIGHT_MS` |
| GameRoom.jsx | 2500 | 摸牌后 fallback 拉取 | 与 ActionLog 或统一「拉取间隔」常量 |
| GameRoom.jsx | 520 | 换牌后 swapJustDone 清除 | 如 `SWAP_DONE_RESET_MS`，与动画时长对齐 |
| GameRoom.jsx | 700 | 换牌飞牌安全超时 | 如 `FLYING_SWAP_FALLBACK_MS` |

集中到 `constants/timing.js` 或各模块顶部常量，便于调整和说明含义。

### 2. 目标分默认 40

除 `gameConfig.js` 外，以下位置直接使用 `40` 作为 fallback：

- `GameRoom.jsx`：`game?.game_state?.target_score || 40`（knockStatus、showdownPlayerStatus）
- `gameStore.js`：`game.game_state?.target_score || 40`（多处）
- `handEvaluation.js`：`evaluateHand(hand, targetScore = 40, ...)`
- `Lobby.jsx`：`useState(40)`

建议：所有「默认目标分」均改为 `GAME_CONFIG.DEFAULT_TARGET_SCORE`，避免与配置不一致。

### 3. 手牌张数默认 5

`handEvaluation.js` 中多处 `handSize = 5`。若项目长期只支持 5/6 且与 `game.hand_size` 一致，可保留默认 5，但调用方应尽量传入 `game.hand_size ?? GAME_CONFIG.CARDS_PER_PLAYER`，避免隐式写死。

### 4. 其他

- **App.jsx**：`Math.min(window.innerWidth, window.innerHeight) < 900` 用于判断是否移动端横屏，900 可抽为常量如 `MOBILE_LANDSCAPE_THRESHOLD`。
- **gameConfig.js**：`GAME_CONFIG.TARGET_SCORE_OPTIONS` 与下方导出的 `TARGET_SCORE_OPTIONS` 不一致（前者含 35，后者为 [40,45,50]）。建议只保留一处来源（如仅导出数组），或明确「配置用」与「UI 选项用」的区别并加注释。

---

## 四、功能实现与健壮性

### 1. 数据流与原则

- 「只更新 DB，订阅驱动视图」已在架构说明中成文，store 中摸牌、出牌、换牌等已按此实现，方向正确。
- Realtime 与 fallback（如摸牌 2.5s 后 refresh）的搭配清晰，可保持现状；若后续增加更多 fallback，建议统一超时与错误提示策略。

### 2. 错误与边界

- 多数 async action 在 catch 中 `set({ error: error.message, loading: false })` 并 `refreshGameState()`，行为一致。
- 建议统一：用户可见的 `error` 是否有上限长度、是否做简单 sanitize，以及错误是否在 3 秒后自动清除（当前 GameRoom 有 3s clearError），避免长时间占位。
- 若 Supabase 未配置或 key 错误，`createClient` 可能在运行时才暴露问题；可在入口或 config 中增加一次 `VITE_SUPABASE_URL` / `VITE_SUPABASE_ANON_KEY` 的存在性校验，便于尽早报错。

### 3. 可访问性（a11y）

- 扣牌按钮已使用 `aria-label` 包含分数信息，ActionLog 有 `aria-label="出牌记录"`，方向正确。
- 建议后续为其他关键操作按钮、手牌区、公共区等补充有意义的 `aria-label` 或 `aria-describedby`，并对焦点顺序做简单检查（如弹窗打开时焦点移入、关闭时回到触发按钮）。

---

## 五、配置与常量

### 1. gameConfig 重复与单一数据源

- `GAME_CONFIG.TARGET_SCORE_OPTIONS` 与导出的 `TARGET_SCORE_OPTIONS` 语义重叠且数值不完全一致，易造成误解。建议二选一作为「目标分选项」的唯一来源，或明确「仅用于 UI 展示」并删除另一处。
- `ROUND_OPTIONS`、`HAND_SIZE_OPTIONS` 等与 `GAME_CONFIG` 中的默认值应保持同步（例如 Lobby 的默认 4 局、5 张手牌来自这里），避免多处写死。

### 2. 日志

- `logger.js` 中 `Logger.warn` 使用了 `LOG_CATEGORIES.ERROR`，与「警告」语义不符，建议改为 `LOG_CATEGORIES.WARN` 或新增 `WARN: '【警告】'`，避免与 error 混淆。

---

## 六、性能与可维护性

### 1. GameRoom 状态与重渲染

- GameRoom 内 useState 较多（选中牌、飞牌状态、drawInProgress、swapJustDone 等），且部分状态仅被单一子树使用。将「飞牌相关状态」或「手牌选择相关状态」收敛到自定义 Hook（如 `useFlyingCards`、`useCardSelection`），可减轻主组件体积并便于单独测试与复用。
- 若后续发现列表（如手牌列表、玩家列表）在 Realtime 更新时重渲染范围过大，可再考虑对列表项做 memo 或对 store 做选择器订阅以缩小订阅范围。

### 2. ActionLog 轮询

- 当前每 2.5s 轮询 `game_actions`。若 Supabase 已支持 Realtime 对 `game_actions` 的订阅，可考虑改为「订阅 + 首次拉取」，减少轮询；若需保留轮询，建议将间隔与「最多条数」集中在常量中便于调优。

---

## 七、小结与优先级建议

| 优先级 | 类型 | 建议 |
|--------|------|------|
| 高 | 硬编码 | 所有「默认目标分 40」改为 `GAME_CONFIG.DEFAULT_TARGET_SCORE`；Lobby 默认值从 GAME_CONFIG 或 OPTIONS 读取。 |
| 高 | 常量 | 时间相关魔法数字（2500、520、700、320 等）抽成命名常量。 |
| 中 | 重复 | 抽 `getTargetScore(game)`、`getPublicZone(game)`、`getHandSize(game)` 等 helpers，统一 game 状态取值。 |
| 中 | 配置 | 统一 `TARGET_SCORE_OPTIONS` 来源；修复 Logger.warn 的 category。 |
| 中 | Store | 考虑用 `withLoading` 或 `handleActionError` 收敛重复的 try/catch/refresh 模式。 |
| 低 | 结构 | 按需拆分 gameStore、GameRoom；组件按 lobby/game/shared 分子目录。 |
| 低 | 体验 | 环境变量校验、a11y 补充、Realtime 替代轮询等按需推进。 |

以上为基于当前代码的审查结论与改进建议，实施时可按迭代节奏分步进行，优先消除硬编码与重复，再逐步做结构和可维护性优化。
